<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اعتبارسنجی و تنظیم دیتابیس SQLite</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        body {
            font-family: Tahoma, Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            direction: rtl;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-family: inherit;
        }
        button:hover {
            background-color: #45a049;
        }
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>اعتبارسنجی و تنظیم دیتابیس SQLite</h1>
        
        <div id="alert" class="alert" style="display:none;"></div>
        
        <form id="uploadForm">
            <div class="form-group">
                <label for="database">انتخاب فایل دیتابیس:</label>
                <input type="file" id="database" name="database" required>
                <small>فایل دیتابیس SQLite را انتخاب کنید.</small>
            </div>
            <button type="submit">آپلود و اصلاح</button>
        </form>
        
        <div id="loader" class="loader"></div>
    </div>

    <script>
        // بارگذاری SQL.js به صورت غیرهمزمان
        let SQL;
        let requiredTables = ['inbounds', 'outbound_traffics', 'settings', 'users', 'client_traffics'];
        
        // تنظیم پیام‌ها
        function showAlert(message, isSuccess = true) {
            const alertElement = document.getElementById('alert');
            alertElement.textContent = message;
            alertElement.className = isSuccess ? 'alert alert-success' : 'alert alert-error';
            alertElement.style.display = 'block';
        }
        
        function showLoader(show = true) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }
        
        // تابع برای دانلود فایل
        function downloadBlob(data, fileName, mimeType) {
            const blob = new Blob([data], {type: mimeType});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        
        // تابع بررسی جداول مورد نیاز
        function validateTables(db) {
            try {
                // بررسی وجود جداول مورد نیاز
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'")[0];
                
                if (!tables || !tables.values) {
                    return {
                        valid: false,
                        message: "فایل دیتابیس نامعتبر است یا جداول موردنظر را ندارد."
                    };
                }
                
                const existingTables = tables.values.map(v => v[0]);
                
                for (const requiredTable of requiredTables) {
                    if (!existingTables.includes(requiredTable)) {
                        return {
                            valid: false,
                            message: `جدول ${requiredTable} در دیتابیس یافت نشد.`
                        };
                    }
                }
                
                return { valid: true };
            } catch (error) {
                return {
                    valid: false,
                    message: "خطا در بررسی جداول: " + error.message
                };
            }
        }
        
        // پاک کردن فیلدهای مورد نظر در جدول settings
        function clearSettingsFields(db) {
            try {
                const fieldsToEmpty = ['webCertFile', 'webKeyFile', 'webDomain', 'webListen'];
                
                // بررسی وجود جدول settings و ستون‌های موردنظر
                try {
                    db.exec("SELECT " + fieldsToEmpty.join(", ") + " FROM settings LIMIT 1");
                } catch (error) {
                    return {
                        success: false,
                        message: "خطا در دسترسی به فیلدهای جدول settings: " + error.message
                    };
                }
                
                // آپدیت فیلدها
                const updateQuery = "UPDATE settings SET " + fieldsToEmpty.map(field => `${field} = ''`).join(", ");
                db.exec(updateQuery);
                
                return { success: true };
            } catch (error) {
                return {
                    success: false,
                    message: "خطا در پاک کردن فیلدها: " + error.message
                };
            }
        }
        
        // تابع اصلی پردازش فایل دیتابیس
        async function processDatabaseFile(file) {
            try {
                showLoader(true);
                
                // بارگذاری SQL.js اگر هنوز بارگذاری نشده است
                if (!SQL) {
                    const sqlPromise = initSqlJs({
                        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                    });
                    SQL = await sqlPromise;
                }
                
                // خواندن فایل
                const fileBuffer = await file.arrayBuffer();
                const uInt8Array = new Uint8Array(fileBuffer);
                
                // ایجاد دیتابیس در حافظه
                const db = new SQL.Database(uInt8Array);
                
                // بررسی اعتبار جداول
                const validationResult = validateTables(db);
                if (!validationResult.valid) {
                    showLoader(false);
                    showAlert(validationResult.message, false);
                    return;
                }
                
                // پاک کردن فیلدهای موردنظر
                const clearResult = clearSettingsFields(db);
                if (!clearResult.success) {
                    showLoader(false);
                    showAlert(clearResult.message, false);
                    return;
                }
                
                // تبدیل دیتابیس به فایل و دانلود
                const data = db.export();
                downloadBlob(data, "sqlite.db", "application/x-sqlite3");
                
                showLoader(false);
                showAlert("فایل دیتابیس با موفقیت بررسی و اصلاح شد و دانلود شد.");
                
            } catch (error) {
                showLoader(false);
                showAlert("خطا در پردازش فایل: " + error.message, false);
            }
        }
        
        // رویداد ارسال فرم
        document.getElementById('uploadForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const fileInput = document.getElementById('database');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert("لطفاً یک فایل انتخاب کنید.", false);
                return;
            }
            
            processDatabaseFile(file);
        });
    </script>
</body>
</html>
