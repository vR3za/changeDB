<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLite Web Editor</title>
</head>
<body>
    <h2>آپلود دیتابیس SQLite</h2>
    <input type="file" id="uploadFile" accept=".sqlite,.db,.sqlite3">
    <button onclick="processDatabase()">بررسی و اصلاح</button>
    <p id="status"></p>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script>
        async function processDatabase() {
            const fileInput = document.getElementById("uploadFile");
            const statusText = document.getElementById("status");

            if (fileInput.files.length === 0) {
                statusText.innerText = "لطفاً یک فایل دیتابیس انتخاب کنید.";
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async function (event) {
                try {
                    const data = new Uint8Array(event.target.result);

                    // بارگذاری sql.js
                    const SQL = await initSqlJs({ locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${filename}` });
                    const db = new SQL.Database(data);

                    // بررسی وجود جدول settings
                    const tableCheck = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='settings';");
                    if (tableCheck.length === 0) {
                        statusText.innerText = "دیتابیس نامعتبر است. جدول settings یافت نشد.";
                        return;
                    }

                    // اصلاح دیتابیس: تنظیم مقدار value روی رشته خالی برای کلیدهای موردنظر
                    const keysToUpdate = ["webCertFile", "webKeyFile", "webDomain", "webListen"];
                    keysToUpdate.forEach(key => {
                        db.run("UPDATE settings SET value='' WHERE key=?;", [key]);
                    });

                    // دریافت پسوند فایل اصلی
                    const fileExt = file.name.split('.').pop();

                    // ایجاد نام فایل با تاریخ و زمان
                    const now = new Date();
                    const formattedDate = now.getFullYear().toString() + 
                                         String(now.getMonth() + 1).padStart(2, '0') + 
                                         String(now.getDate()).padStart(2, '0') + "_" + 
                                         String(now.getHours()).padStart(2, '0') + 
                                         String(now.getMinutes()).padStart(2, '0') + 
                                         String(now.getSeconds()).padStart(2, '0');

                    const newFileName = `${formattedDate}.${fileExt}`;

                    // ایجاد دیتابیس اصلاح‌شده برای دانلود
                    const modifiedData = db.export();
                    const blob = new Blob([modifiedData], { type: "application/octet-stream" });
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(blob);
                    a.download = newFileName;
                    a.click();

                    statusText.innerText = `عملیات موفقیت‌آمیز بود. فایل اصلاح‌شده (${newFileName}) دانلود شد!`;
                } catch (error) {
                    statusText.innerText = "خطا در پردازش دیتابیس: " + error.message;
                }
            };

            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
